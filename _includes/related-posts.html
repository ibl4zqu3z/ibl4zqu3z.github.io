{%- assign limit = 2 -%}
{%- assign shown = 0 -%}
{%- assign used = "|" -%}

<section class="mt-5 related-posts">
  <h2 class="h5 mb-3">Artículos relacionados</h2>

  <div class="related-list">
    {%- comment -%}PASS 1: tags/categorías en común{%- endcomment -%}
    {%- for p in site.posts -%}
      {%- if p.url == page.url -%}{%- continue -%}{%- endif -%}

      {%- assign score = 0 -%}

      {%- if page.tags and p.tags -%}
        {%- for t in p.tags -%}
          {%- if page.tags contains t -%}
            {%- assign score = score | plus: 1 -%}
          {%- endif -%}
        {%- endfor -%}
      {%- endif -%}

      {%- if page.categories and p.categories -%}
        {%- for c in p.categories -%}
          {%- if page.categories contains c -%}
            {%- assign score = score | plus: 1 -%}
          {%- endif -%}
        {%- endfor -%}
      {%- endif -%}

      {%- if score > 0 -%}
        {%- assign img = p.image
          | default: p.featured_image
          | default: p.thumbnail
          | default: p.header.teaser
          | default: p.header.image
        -%}

        {%- assign badge = nil -%}
        {%- if p.categories and p.categories.size > 0 -%}
          {%- assign badge = p.categories[0] -%}
        {%- elsif p.tags and p.tags.size > 0 -%}
          {%- assign badge = p.tags[0] -%}
        {%- endif -%}

        <a class="related-card" href="{{ p.url | relative_url }}">
          <div class="related-card__thumb">
            {%- if img -%}
              <img
                src="{{ img | relative_url }}"
                alt="{{ p.title | escape }}"
                class="related-card__img"
                loading="lazy"
              >
            {%- else -%}
              <div class="related-card__placeholder"></div>
            {%- endif -%}
          </div>

          <div class="related-card__body">
            <div class="related-card__title">{{ p.title | escape }}</div>
            {%- if badge -%}
              <span class="related-card__badge">{{ badge }}</span>
            {%- endif -%}
          </div>
        </a>

        {%- assign shown = shown | plus: 1 -%}
        {%- capture used -%}{{ used }}{{ p.url }}|{%- endcapture -%}
      {%- endif -%}

      {%- if shown == limit -%}{%- break -%}{%- endif -%}
    {%- endfor -%}

    {%- comment -%}PASS 2: relleno con recientes (sin duplicar){%- endcomment -%}
    {%- if shown < limit -%}
      {%- for p in site.posts -%}
        {%- if p.url == page.url -%}{%- continue -%}{%- endif -%}
        {%- if used contains p.url -%}{%- continue -%}{%- endif -%}

        {%- assign img = p.image
          | default: p.featured_image
          | default: p.thumbnail
          | default: p.header.teaser
          | default: p.header.image
        -%}

        {%- assign badge = nil -%}
        {%- if p.categories and p.categories.size > 0 -%}
          {%- assign badge = p.categories[0] -%}
        {%- elsif p.tags and p.tags.size > 0 -%}
          {%- assign badge = p.tags[0] -%}
        {%- endif -%}

        <a class="related-card" href="{{ p.url | relative_url }}">
          <div class="related-card__thumb">
            {%- if img -%}
              <img
                src="{{ img | relative_url }}"
                alt="{{ p.title | escape }}"
                class="related-card__img"
                loading="lazy"
              >
            {%- else -%}
              <div class="related-card__placeholder"></div>
            {%- endif -%}
          </div>

          <div class="related-card__body">
            <div class="related-card__title">{{ p.title | escape }}</div>
            {%- if badge -%}
              <span class="related-card__badge">{{ badge }}</span>
            {%- endif -%}
          </div>
        </a>

        {%- assign shown = shown | plus: 1 -%}
        {%- capture used -%}{{ used }}{{ p.url }}|{%- endcapture -%}

        {%- if shown == limit -%}{%- break -%}{%- endif -%}
      {%- endfor -%}
    {%- endif -%}
  </div>
</section>
